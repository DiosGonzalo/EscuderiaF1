<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Almacén - Componentes Disponibles</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" rel="stylesheet">
</head>

<body class="bg-dark text-light">

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-black shadow-sm fixed-top">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold text-warning fs-4" href="#">
                <i class="bi bi-speedometer2 me-2"></i>
                Escudería F1
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link fw-semibold" th:href="@{/dashboard}">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link fw-semibold" th:href="@{/garaje}">
                            <i class="bi bi-car-front-fill"></i> Garaje
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active fw-semibold" aria-current="page" th:href="@{/almacen}">
                            <i class="bi bi-box-seam"></i> Almacén
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link fw-semibold" th:href="@{/carreras}">
                            <i class="bi bi-flag-fill"></i> Carreras
                        </a>
                    </li> 
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-5 mt-5">

        <!-- Título principal -->
        <div class="text-center mb-5 animate__animated animate__fadeInDown">
            <h1 class="display-3 fw-bold text-warning mb-3">
                <i class="bi bi-box-seam-fill"></i> Almacén de Componentes
            </h1>
            <div class="bg-warning mx-auto mb-3 rounded" style="height: 4px; width: 100px;"></div>
            <p class="lead text-light">Gestiona y organiza todos los componentes disponibles</p>
        </div>

        <!-- Panel de Filtros y Búsqueda -->
        <div class="row mb-4 animate__animated animate__fadeInUp">
            <div class="col-12">
                <div class="card bg-black border-warning shadow-lg rounded-4">
                    <div class="card-body p-4">
                        <h5 class="card-title fw-bold mb-4 text-warning">
                            <i class="bi bi-funnel-fill me-2"></i>
                            Filtros y Búsqueda
                        </h5>
                        
                        <div class="row g-3">
                            <!-- Búsqueda por nombre -->
                            <div class="col-md-4">
                                <form th:action="@{/almacen/buscarNombre}" method="post" class="d-flex gap-2">
                                    <div class="input-group">
                                        <span class="input-group-text bg-warning text-dark border-warning">
                                            <i class="bi bi-search"></i>
                                        </span>
                                        <input type="text" 
                                               name="nombre" 
                                               class="form-control bg-dark text-light border-warning" 
                                               placeholder="Buscar por nombre..."
                                               th:value="${nombreBuscado}">
                                        <button type="submit" class="btn btn-warning">
                                            Buscar
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- Filtrar por tipo -->
                            <div class="col-md-4">
                                <form th:action="@{/almacen/filtrar/tipo}" method="post">
                                    <div class="input-group">
                                        <span class="input-group-text bg-info text-dark border-info">
                                            <i class="bi bi-filter"></i>
                                        </span>
                                        <select name="tipo" class="form-select bg-dark text-light border-info" onchange="this.form.submit()">
                                            <option value="">Filtrar por tipo...</option>
                                            <option value="MOTOR">MOTOR</option>
                                            <option value="TURBO">TURBO</option>
                                            <option value="BATERIA">BATERÍA</option>
                                            <option value="CAJA_DE_CAMBIOS">CAJA DE CAMBIOS</option>
                                            <option value="NEUMATICOS">NEUMÁTICOS</option>
                                            <option value="ALERON">ALERÓN</option>
                                            <option value="PARAGOLPES">PARAGOLPES</option>
                                            <option value="SUSPENSION">SUSPENSIÓN</option>
                                            <option value="DIRECCION">DIRECCIÓN</option>
                                        </select>
                                    </div>
                                </form>
                            </div>

                            <!-- Ordenar -->
                            <div class="col-md-4">
                                <div class="btn-group w-100 shadow-sm" role="group">
                                    <form th:action="@{/almacen/ordenarUsosMenor}" method="post" class="d-inline">
                                        <button type="submit" class="btn btn-outline-success" data-bs-toggle="tooltip" title="Menos usado primero">
                                            <i class="bi bi-sort-down"></i> Menos
                                        </button>
                                    </form>
                                    <form th:action="@{/almacen/ordenarUsosMayor}" method="post" class="d-inline">
                                        <button type="submit" class="btn btn-outline-warning" data-bs-toggle="tooltip" title="Más usado primero">
                                            <i class="bi bi-sort-up"></i> Más
                                        </button>
                                    </form>
                                    <form th:action="@{/almacen/mejores}" method="post" class="d-inline">
                                        <button type="submit" class="btn btn-outline-danger" data-bs-toggle="tooltip" title="Mejores componentes">
                                            <i class="bi bi-trophy-fill"></i> Top
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Botón limpiar filtros -->
                        <div class="row mt-3">
                            <div class="col-12 text-end">
                                <a th:href="@{/almacen}" class="btn btn-secondary btn-sm">
                                    <i class="bi bi-x-circle"></i> Limpiar Filtros
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estadísticas rápidas -->
        <div class="row g-4 mb-4 animate__animated animate__fadeInUp animate__delay-1s">
            <div class="col-md-3">
                <div class="card bg-black border-warning shadow-lg h-100">
                    <div class="card-body text-center p-4">
                        <div class="bg-warning text-dark rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 70px; height: 70px;">
                            <i class="bi bi-box-seam fs-2"></i>
                        </div>
                        <h3 class="fw-bold mb-1 text-warning" th:text="${componentes != null ? componentes.size() : 0}">0</h3>
                        <p class="text-light mb-0 small">Total Componentes</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-black border-success shadow-lg h-100">
                    <div class="card-body text-center p-4">
                        <div class="bg-success text-dark rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 70px; height: 70px;">
                            <i class="bi bi-check-circle fs-2"></i>
                        </div>
                        <h3 class="fw-bold mb-1 text-success" th:text="${componentesSinCoche != null ? componentesSinCoche.size() : 0}">0</h3>
                        <p class="text-light mb-0 small">Disponibles</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-black border-danger shadow-lg h-100">
                    <div class="card-body text-center p-4">
                        <div class="bg-danger text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 70px; height: 70px;">
                            <i class="bi bi-gear-fill fs-2"></i>
                        </div>
                        <h3 class="fw-bold mb-1 text-danger" th:text="${componentes != null ? (componentes.size() - (componentesSinCoche != null ? componentesSinCoche.size() : 0)) : 0}">0</h3>
                        <p class="text-light mb-0 small">En Uso</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-black border-info shadow-lg h-100">
                    <div class="card-body text-center p-4">
                        <div class="bg-info text-dark rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 70px; height: 70px;">
                            <i class="bi bi-layers-fill fs-2"></i>
                        </div>
                        <h3 class="fw-bold mb-1 text-info" th:text="${tipos != null ? tipos.size() : 0}">0</h3>
                        <p class="text-light mb-0 small">Tipos Diferentes</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerta cuando no hay componentes -->
        <div th:if="${#lists.isEmpty(componentes)}" class="alert alert-dark border-warning shadow-sm text-center py-5 mb-5 animate__animated animate__shakeX">
            <i class="bi bi-inbox text-warning" style="font-size: 5rem;"></i>
            <h4 class="mt-3 text-light">El almacén está vacío</h4>
            <p class="text-muted">¡Es hora de comprar nuevos componentes para tu escudería!</p>
        </div>

        <!-- Lista de componentes -->
        <div th:unless="${#lists.isEmpty(componentes)}">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="text-warning fw-bold">
                    <i class="bi bi-card-list"></i> 
                    Inventario 
                    <span class="badge bg-warning text-dark" th:text="${componentes.size()}">0</span>
                </h3>
                <div class="btn-group shadow-sm" role="group">
                    <button type="button" class="btn btn-warning active" id="gridView">
                        <i class="bi bi-grid-3x3-gap-fill"></i> Grid
                    </button>
                    <button type="button" class="btn btn-outline-warning" id="listView">
                        <i class="bi bi-list-ul"></i> Lista
                    </button>
                </div>
            </div>

            <div class="row g-4 animate__animated animate__fadeInUp" id="componentesContainer">
                <div class="col-sm-6 col-md-4 col-lg-3 componente-item" th:each="comp : ${componentes}">
                    <div class="card bg-black border-warning h-100 shadow-lg overflow-hidden">
                        
                        <!-- Header del componente -->
                        <div class="card-header border-warning p-3" 
                             th:classappend="${comp.coche != null} ? 'bg-danger text-white' : 'bg-dark text-light'">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <span class="badge rounded-pill mb-2" 
                                          th:classappend="${comp.coche != null} ? 'bg-white text-danger' : 'bg-success text-white'">
                                        <i th:class="${comp.coche != null ? 'bi bi-x-circle-fill' : 'bi bi-check-circle-fill'}"></i>
                                        <span th:text="${comp.coche != null ? 'En Uso' : 'Disponible'}"></span>
                                    </span>
                                    <h6 class="fw-bold mb-0" th:text="${comp.tipo}">Tipo</h6>
                                </div>
                                <small class="badge bg-warning text-dark rounded-pill">ID: <span th:text="${comp.id}"></span></small>
                            </div>
                        </div>

                        <!-- Body del componente -->
                        <div class="card-body p-3">
                            <h5 class="card-title fw-bold text-warning mb-3" th:text="${comp.nombre}">Nombre</h5>
                            
                            <!-- Info rápida -->
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <div class="bg-dark border border-warning rounded-3 p-2 text-center">
                                        <i class="bi bi-speedometer text-warning"></i>
                                        <div class="fw-bold small text-light" th:text="${comp.caballos} + ' CV'">0 CV</div>
                                        <small class="text-muted" style="font-size: 0.7rem;">Potencia</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="bg-dark border border-success rounded-3 p-2 text-center">
                                        <i class="bi bi-activity text-success"></i>
                                        <div class="fw-bold small text-light" th:text="${#numbers.formatDecimal(comp.estado * 100, 0, 0)} + '%'">100%</div>
                                        <small class="text-muted" style="font-size: 0.7rem;">Estado</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Si está en uso -->
                            <div th:if="${comp.coche != null}" class="alert alert-warning p-2 mb-3 small border-0 rounded-3">
                                <i class="bi bi-car-front-fill"></i> 
                                <strong>Instalado en:</strong><br>
                                <span th:text="${comp.coche.modelo}"></span>
                                <span th:if="${comp.coche.piloto}"> (<span th:text="${comp.coche.piloto}"></span>)</span>
                            </div>

                            <!-- Usos restantes -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-light fw-semibold">
                                        <i class="bi bi-clock-history"></i> Usos
                                    </small>
                                    <small class="fw-bold" 
                                           th:classappend="${(comp.vecesUsado / comp.limiteUsos) >= 0.8} ? 'text-danger' : (${(comp.vecesUsado / comp.limiteUsos) >= 0.5} ? 'text-warning' : 'text-success')">
                                        <span th:text="${comp.vecesUsado}">0</span>/<span th:text="${comp.limiteUsos}">0</span>
                                    </small>
                                </div>
                                <div class="progress rounded-pill" style="height: 8px;">
                                    <div class="progress-bar rounded-pill" 
                                         th:classappend="${(comp.vecesUsado / comp.limiteUsos) >= 0.8} ? 'bg-danger' : (${(comp.vecesUsado / comp.limiteUsos) >= 0.5} ? 'bg-warning' : 'bg-success')"
                                         role="progressbar"
                                         th:style="'width: ' + ((${comp.vecesUsado} * 100) / ${comp.limiteUsos}) + '%'"
                                         th:attr="aria-valuenow=${comp.vecesUsado}, aria-valuemin='0', aria-valuemax=${comp.limiteUsos}">
                                    </div>
                                </div>
                                <small class="text-muted" style="font-size: 0.7rem;">
                                    <span th:text="${comp.limiteUsos - comp.vecesUsado}">0</span> usos restantes
                                </small>
                            </div>
                        </div>

                        <!-- Footer con acción -->
                        <div class="card-footer bg-black border-warning p-3">
                            <a th:href="@{/almacen/componente/{id}(id=${comp.id})}" 
                               class="btn btn-warning w-100 rounded-3">
                                <i class="bi bi-eye"></i> Ver Detalles
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>

    <!-- Footer -->
    <footer class="bg-black text-warning text-center py-4 mt-5 shadow-lg border-top border-warning">
        <div class="container">
            <p class="mb-0">
                <i class="bi bi-box-seam"></i>
                <strong>Almacén F1</strong> - Sistema de Inventario
            </p>
            <small class="text-muted">Powered by Bootstrap 5</small>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Inicializar tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        // Cambiar vista Grid/Lista
        const gridView = document.getElementById('gridView');
        const listView = document.getElementById('listView');
        const container = document.getElementById('componentesContainer');

        listView?.addEventListener('click', function() {
            container.classList.remove('row', 'g-4');
            container.classList.add('d-flex', 'flex-column', 'gap-3');
            
            document.querySelectorAll('.componente-item').forEach(item => {
                item.classList.remove('col-sm-6', 'col-md-4', 'col-lg-3');
                item.classList.add('w-100');
            });
            
            gridView.classList.remove('active');
            gridView.classList.add('btn-outline-warning');
            gridView.classList.remove('btn-warning');
            
            this.classList.add('active');
            this.classList.remove('btn-outline-warning');
            this.classList.add('btn-warning');
        });

        gridView?.addEventListener('click', function() {
            container.classList.add('row', 'g-4');
            container.classList.remove('d-flex', 'flex-column', 'gap-3');
            
            document.querySelectorAll('.componente-item').forEach(item => {
                item.classList.add('col-sm-6', 'col-md-4', 'col-lg-3');
                item.classList.remove('w-100');
            });
            
            listView.classList.remove('active');
            listView.classList.add('btn-outline-warning');
            listView.classList.remove('btn-warning');
            
            this.classList.add('active');
            this.classList.remove('btn-outline-warning');
            this.classList.add('btn-warning');
        });
    </script>
</body>
</html>